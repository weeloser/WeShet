<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeShet - Менеджер Турниров</title>
    <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/5N76CRTL/Weshet-LOGO.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --background: #0f0f12;
            --surface1: #1a1a1f;
            --surface2: #25252c;
            --primary: #a855f7;
            --primary-hover: #9333ea;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --glow-color: rgba(168, 85, 247, 0.5);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface2); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background); 
            color: var(--text-primary);
            background-image: radial-gradient(circle at 1px 1px, var(--surface1) 1px, transparent 0);
            background-size: 20px 20px;
        }
        .main-container { max-width: 1700px; margin: 0 auto; padding: 1rem; md:padding: 1rem 2rem; }
        .card { 
            background-color: var(--surface1); 
            border-radius: 1rem; 
            border: 1px solid var(--border-color); 
            padding: 1.5rem; 
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .card:hover { 
            border-color: var(--primary); 
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 20px var(--glow-color);
        }
        .card-header { 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 1rem; 
            margin-bottom: 1rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; 
            padding: 0.75rem 1.25rem; border-radius: 0.75rem; 
            font-weight: 600; transition: all 0.3s ease; 
            cursor: pointer; 
            border: 1px solid transparent; 
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            white-space: nowrap;
        }
        .btn-primary { 
            background-image: linear-gradient(to right, #a855f7, #7c3aed);
            color: white; 
        }
        .btn-primary:hover { 
            transform: scale(1.05) translateY(-2px); 
            box-shadow: 0 6px 20px var(--glow-color);
        }
        .btn-secondary { background-color: var(--surface2); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); border-color: var(--text-secondary); transform: scale(1.05); }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; transform: scale(1.05); }
        .input-field { 
            width: 100%; background-color: var(--surface2); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); border-radius: 0.75rem; 
            padding: 0.75rem 1rem; transition: all 0.3s ease;
        }
        .input-field:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px var(--glow-color); 
        }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 40; display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { 
            background-color: var(--surface1); 
            padding: 2rem; 
            border-radius: 1rem; 
            width: 100%; 
            max-width: 600px; 
            transform: translateY(-20px) scale(0.95); 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            max-height: 90vh; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-backdrop.active .modal-content { transform: translateY(0) scale(1); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        thead { background-color: var(--surface2); }
        tbody tr { transition: background-color 0.2s ease; }
        tbody tr:hover { background-color: var(--surface2); }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .result-select { background-color: var(--surface2); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; color: var(--text-primary); }
        .app-header { 
            font-size: 2rem;
            sm:font-size: 2.5rem; 
            font-weight: 800; 
            letter-spacing: -1px; 
            background: linear-gradient(90deg, #f1f5f9, #a855f7); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px var(--glow-color);
        }
        .player-name-clickable { cursor: pointer; text-decoration: none; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .player-name-clickable:hover { color: var(--primary); border-bottom-color: var(--primary); }
        .participant-item { animation: popIn 0.4s ease-out; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="text-text-primary">

    <div id="app-container" class="main-container">
        <div id="home-screen" class="screen">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-6 mb-10">
                <h1 class="app-header">WeShet</h1>
                <button id="go-to-setup-btn" class="btn btn-primary text-lg w-full sm:w-auto"><i class="fas fa-plus mr-2"></i>Создать турнир</button>
            </div>
            <div id="tournaments-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            <div id="no-tournaments-view" class="hidden text-center py-20">
                 <i class="fas fa-chess-rook text-6xl text-gray-700 mb-4 animate-pulse"></i>
                 <h2 class="text-2xl font-bold text-white">Пока пусто</h2>
                 <p class="text-text-secondary mt-2">Начните свой первый турнир, это просто!</p>
            </div>
        </div>

        <div id="setup-screen" class="screen">
            <div class="card max-w-3xl mx-auto">
                <div class="card-header"><h2 class="text-2xl font-bold text-white">Настройка Турнира</h2></div>
                <form id="tournament-setup-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="tournament-name" class="block mb-2 font-semibold">Название турнира</label>
                            <input type="text" id="tournament-name" class="input-field" placeholder="Например, 'Кубок WeShet 2025'" required>
                        </div>
                        <div>
                            <label for="total-rounds" class="block mb-2 font-semibold">Количество туров</label>
                            <input type="number" id="total-rounds" class="input-field" min="1" max="25" value="7" required>
                        </div>
                        <div>
                            <label for="time-control" class="block mb-2 font-semibold">Контроль времени</label>
                            <input type="text" id="time-control" class="input-field" placeholder="Например, '5+3'">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">Рейтинговый турнир</label>
                            <label class="inline-flex items-center cursor-pointer">
                              <input type="checkbox" id="is-rated-toggle" class="sr-only peer">
                              <div class="relative w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>
                    <div id="rating-settings-panel" class="hidden mt-6 space-y-4 p-4 bg-surface2 rounded-lg">
                        <h3 class="text-lg font-semibold">Настройки рейтинга</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="rating-system" class="block mb-2 font-semibold">Система</label>
                                <select id="rating-system" class="input-field">
                                    <option value="fide">FIDE</option>
                                    <option value="fsr">ФШР</option>
                                </select>
                            </div>
                            <div>
                                <label for="k-factor" class="block mb-2 font-semibold">K-фактор</label>
                                <select id="k-factor" class="input-field">
                                    <option value="40">40 (для новичков/быстрые)</option>
                                    <option value="20">20 (стандарт)</option>
                                    <option value="10">10 (для топ-игроков)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex flex-col-reverse sm:flex-row justify-between items-center gap-4">
                        <button type="button" id="back-to-home-btn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-arrow-left mr-2"></i>Назад</button>
                        <button type="submit" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-users mr-2"></i>К участникам</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="tournament-dashboard" class="screen">
            <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center flex-wrap gap-4">
                <div>
                    <button id="back-to-home-dashboard-btn" class="text-text-secondary hover:text-white mb-2 transition-colors"><i class="fas fa-arrow-left mr-2"></i>Все турниры</button>
                    <h1 id="dashboard-title" class="text-3xl lg:text-4xl font-bold text-white"></h1>
                    <p id="dashboard-subtitle" class="text-text-secondary"></p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="settings-btn" class="btn btn-secondary"><i class="fas fa-cog mr-2"></i>Настройки</button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div id="participants-card" class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-bold text-white">Участники</h2>
                            <span id="participants-count" class="text-sm font-bold bg-primary text-white px-3 py-1 rounded-full">0</span>
                        </div>
                        <form id="add-participant-form" class="flex flex-col sm:flex-row gap-3 mb-4">
                            <input type="text" id="participant-name" class="input-field flex-grow" placeholder="Имя участника" required>
                            <input type="number" id="participant-rating" class="input-field w-full sm:w-24" placeholder="Рейтинг">
                            <button type="submit" class="btn btn-primary flex-shrink-0"><i class="fas fa-plus"></i></button>
                        </form>
                        <ul id="participants-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></ul>
                    </div>
                     <div id="notepad-card" class="card">
                        <div class="card-header"><h2 class="text-xl font-bold text-white"><i class="fas fa-book-open mr-2"></i>Блокнот</h2></div>
                        <textarea id="notepad-content" class="input-field w-full h-48 resize-none" placeholder="Заметки по турниру..."></textarea>
                    </div>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div id="pairings-card" class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-bold text-white">Жеребьевка</h2>
                            <div id="round-controls" class="flex items-center gap-2 flex-wrap justify-end"></div>
                        </div>
                        <div id="pairings-view"></div>
                    </div>

                    <div id="standings-card" class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-bold text-white">Турнирная таблица</h2>
                            <button id="copy-standings-btn" class="btn btn-secondary btn-sm" title="Копировать таблицу"><i class="fas fa-copy"></i></button>
                        </div>
                        <div id="standings-view" class="table-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">Настройки Турнира</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2">Дополнительные коэффициенты</h3>
                    <p class="text-sm text-text-secondary mb-3">Укажите приоритет (1 - самый важный). 0 - отключить.</p>
                    <div id="tiebreakers-list" class="space-y-3"></div>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold">Опасная зона</h3>
                    <button id="delete-tournament-btn" class="btn btn-danger w-full mt-2"><i class="fas fa-trash-alt mr-2"></i>Удалить этот турнир</button>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="close-settings-modal-btn" class="btn btn-primary">Закрыть</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Вы уверены?</h2>
            <p id="confirm-modal-text" class="text-text-secondary mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">Отмена</button>
                <button id="confirm-modal-ok-btn" class="btn btn-danger">Подтвердить</button>
            </div>
        </div>
    </div>

    <div id="player-info-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="player-info-title" class="text-2xl font-bold mb-6">История партий</h2>
            <div id="player-info-content" class="space-y-3"></div>
            <div class="mt-8 flex justify-end">
                <button id="close-player-info-modal-btn" class="btn btn-primary">Закрыть</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let tournaments = [];
        let currentTournamentId = null;
        const TIEBREAKERS = {
            directEncounter: "Личная встреча",
            berger: "Коэфф. Бергера",
            buchholz: "Коэфф. Бухгольца",
            medianBuchholz: "Усеч. Бухгольц",
            sonnebornBerger: "Коэфф. Зоннеборна-Бергера",
            wins: "Количество побед",
            winsWithBlack: "Побед черными",
            koya: "Система Койя",
            progressive: "Прогрессивный коэфф."
        };

        const screens = { home: document.getElementById('home-screen'), setup: document.getElementById('setup-screen'), dashboard: document.getElementById('tournament-dashboard') };
        const tournamentsList = document.getElementById('tournaments-list');
        const noTournamentsView = document.getElementById('no-tournaments-view');
        const goToSetupBtn = document.getElementById('go-to-setup-btn');
        const setupForm = document.getElementById('tournament-setup-form');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const backToHomeDashboardBtn = document.getElementById('back-to-home-dashboard-btn');
        const dashboardTitle = document.getElementById('dashboard-title');
        const dashboardSubtitle = document.getElementById('dashboard-subtitle');
        const participantsList = document.getElementById('participants-list');
        const participantsCount = document.getElementById('participants-count');
        const addParticipantForm = document.getElementById('add-participant-form');
        const participantRatingInput = document.getElementById('participant-rating');
        const standingsView = document.getElementById('standings-view');
        const pairingsView = document.getElementById('pairings-view');
        const roundControls = document.getElementById('round-controls');
        const settingsBtn = document.getElementById('settings-btn');
        const copyStandingsBtn = document.getElementById('copy-standings-btn');
        
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
        const deleteTournamentBtn = document.getElementById('delete-tournament-btn');
        const playerInfoModal = document.getElementById('player-info-modal');
        const playerInfoTitle = document.getElementById('player-info-title');
        const playerInfoContent = document.getElementById('player-info-content');
        const closePlayerInfoModalBtn = document.getElementById('close-player-info-modal-btn');

        const isRatedToggle = document.getElementById('is-rated-toggle');
        const ratingSettingsPanel = document.getElementById('rating-settings-panel');
        const tiebreakersList = document.getElementById('tiebreakers-list');
        const notepadContent = document.getElementById('notepad-content');
        const totalRoundsInput = document.getElementById('total-rounds');
        const confirmModal = {
            el: document.getElementById('confirm-modal'),
            title: document.getElementById('confirm-modal-title'),
            text: document.getElementById('confirm-modal-text'),
            okBtn: document.getElementById('confirm-modal-ok-btn'),
            cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
        };

        const initializeApp = () => {
            loadAllTournaments();
            renderHomeScreen();
            showScreen('home');
        };

        const showScreen = (screenName) => {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[screenName].classList.add('active');
        };

        const toggleModal = (modal, show) => {
            if (show) {
                modal.classList.add('active');
            } else {
                modal.classList.remove('active');
            }
        };
        
        const showConfirmModal = (title, text, onConfirm, options = {}) => {
            const { okText = 'Подтвердить', cancelText = 'Отмена', showCancel = true } = options;
            confirmModal.title.textContent = title;
            confirmModal.text.textContent = text;
            confirmModal.okBtn.textContent = okText;
            confirmModal.cancelBtn.textContent = cancelText;
            confirmModal.cancelBtn.style.display = showCancel ? 'inline-flex' : 'none';
            toggleModal(confirmModal.el, true);

            return new Promise((resolve) => {
                const okHandler = () => {
                    if(typeof onConfirm === 'function') onConfirm();
                    resolve(true);
                    cleanup();
                };
                const cancelHandler = () => {
                    resolve(false);
                    cleanup();
                };
                const cleanup = () => {
                    toggleModal(confirmModal.el, false);
                    confirmModal.okBtn.removeEventListener('click', okHandler);
                    confirmModal.cancelBtn.removeEventListener('click', cancelHandler);
                };
                confirmModal.okBtn.addEventListener('click', okHandler, { once: true });
                confirmModal.cancelBtn.addEventListener('click', cancelHandler, { once: true });
            });
        };
        
        const showAlertModal = (title, text) => {
            return showConfirmModal(title, text, null, { okText: 'OK', showCancel: false });
        };

        const saveAllTournaments = () => {
            try {
                localStorage.setItem('WeShet_v10', JSON.stringify(tournaments));
            } catch (e) {
                console.error("Error saving to localStorage", e);
            }
        };
        const loadAllTournaments = () => {
            const data = localStorage.getItem('WeShet_v10');
            tournaments = data ? JSON.parse(data) : [];
        };
        const getTournamentById = (id) => tournaments.find(t => t.id === id);
        const getCurrentTournament = () => getTournamentById(currentTournamentId);
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const renderHomeScreen = () => {
            tournamentsList.innerHTML = '';
            const sortedTournaments = tournaments.sort((a, b) => (b.lastModified || 0) - (a.lastModified || 0));

            if (sortedTournaments.length === 0) {
                noTournamentsView.classList.remove('hidden');
                tournamentsList.classList.add('hidden');
                return;
            }
            noTournamentsView.classList.add('hidden');
            tournamentsList.classList.remove('hidden');

            sortedTournaments.forEach(t => {
                const isFinished = t.currentRound === t.settings.totalRounds && t.pairings[t.currentRound - 1]?.completed;
                const card = document.createElement('div');
                card.className = 'card cursor-pointer';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-white pr-4">${t.name}</h3>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap ${isFinished ? 'bg-green-600' : 'bg-yellow-600/80'}">${isFinished ? 'Завершен' : 'Идет'}</span>
                    </div>
                    <p class="text-sm text-text-secondary">${t.participants.length} участн. / ${t.settings.totalRounds} туров</p>
                    <div class="mt-4 pt-4 border-t border-border-color flex justify-end">
                         <button class="btn btn-sm btn-danger delete-btn-home" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                card.addEventListener('click', async (e) => {
                    if (e.target.closest('.delete-btn-home')) {
                        e.stopPropagation();
                        await showConfirmModal(
                            'Удалить турнир?', 
                            `Вы уверены, что хотите удалить турнир "${t.name}"? Это действие необратимо.`,
                            () => {
                                tournaments = tournaments.filter(tourn => tourn.id !== t.id);
                                saveAllTournaments();
                                renderHomeScreen();
                            }
                        );
                    } else {
                        currentTournamentId = t.id;
                        renderDashboard();
                        showScreen('dashboard');
                    }
                });
                tournamentsList.appendChild(card);
            });
        };

        const renderDashboard = () => {
            const t = getCurrentTournament();
            if (!t) return;
            
            updateAllScores();
            t.lastModified = Date.now();
            saveAllTournaments();

            dashboardTitle.textContent = t.name;
            dashboardSubtitle.textContent = `Швейцарская система, ${t.settings.totalRounds} туров, ${t.timeControl || 'без контроля'}${t.settings.isRated ? `, Рейтинг ${t.settings.ratingSystem.toUpperCase()}` : ''}`;
            participantRatingInput.style.display = t.settings.isRated ? 'block' : 'none';
            notepadContent.value = t.notepadContent || '';
            addParticipantForm.style.display = t.currentRound > 0 ? 'none' : 'flex';
            renderParticipants();
            renderStandings();
            renderRoundControls();
            renderPairings();
        };

        const renderParticipants = () => {
            const t = getCurrentTournament();
            participantsList.innerHTML = '';
            if (!t) return;
            t.participants.sort((a, b) => (b.rating || 0) - (a.rating || 0)).forEach(p => {
                const li = document.createElement('li');
                li.className = `flex justify-between items-center bg-surface2 p-3 rounded-lg transition-all duration-300 participant-item ${p.frozen ? 'opacity-40' : ''}`;
                li.innerHTML = `
                    <div class="truncate">
                        <span class="font-bold">${p.name}</span>
                        ${t.settings.isRated ? `<span class="text-xs text-text-secondary ml-2">${p.rating || 'N/A'}</span>` : ''}
                    </div>
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <button class="text-blue-400 hover:text-blue-300 transition-colors freeze-participant-btn" data-id="${p.id}" title="${p.frozen ? 'Разморозить' : 'Заморозить'}">
                            <i class="fas fa-${p.frozen ? 'play' : 'snowflake'}"></i>
                        </button>
                        ${t.currentRound === 0 ? `<button class="text-red-500 hover:text-red-400 text-2xl font-light leading-none transition-colors delete-participant-btn" data-id="${p.id}">&times;</button>` : ''}
                    </div>
                `;
                participantsList.appendChild(li);
            });
            participantsCount.textContent = t.participants.length;
        };

        const renderStandings = () => {
            const t = getCurrentTournament();
            if (!t || t.participants.length === 0) {
                standingsView.innerHTML = `<p class="text-text-secondary text-center py-4">Результаты появятся здесь.</p>`;
                return;
            }

            const sortedByScore = getSortedParticipants();
            const activeTiebreakers = t.settings.tiebreakers.filter(tb => tb.priority > 0).sort((a, b) => a.priority - b.priority);

            let tableHtml = `<table class="w-full table-auto"><thead><tr>
                <th class="w-1/3">Участник</th>
                ${t.settings.isRated ? '<th class="w-24 text-center">Рейт.</th>' : ''}
                <th class="w-20 text-center">Очки</th>`;

            const maxRounds = t.settings.totalRounds;
            for (let i = 1; i <= maxRounds; i++) {
                tableHtml += `<th class="w-16 text-center hidden md:table-cell">${i}</th>`;
            }

            activeTiebreakers.forEach(tb => {
                if (TIEBREAKERS[tb.key]) tableHtml += `<th class="w-24 text-right hidden lg:table-cell">${TIEBREAKERS[tb.key].split(' ').map(w => w.slice(0, 3)).join('.')}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            sortedByScore.forEach((p) => {
                tableHtml += `<tr class="${p.frozen ? 'opacity-40' : ''}">
                    <td class="w-1/3 font-bold"><span class="player-name-clickable" data-player-id="${p.id}">${p.name}</span></td>
                    ${t.settings.isRated ? `<td class="w-24 text-center">${p.rating || '-'}</td>` : ''}
                    <td class="w-20 text-center font-bold text-lg">${p.score.toFixed(1).replace('.0', '')}</td>`;

                for (let i = 0; i < maxRounds; i++) {
                    let roundCell = '';
                    const opponentId = p.opponents[i];
                    const result = p.results[i];

                    if (opponentId !== undefined) {
                        if (opponentId === 'bye') {
                            roundCell = `<span title="Пропуск тура" class="text-green-400">bye</span>`;
                        } else {
                            const opponent = getParticipantById(opponentId);
                            if (opponent) {
                                const title = `vs ${opponent.name} (${p.colors[i]})`;
                                roundCell = `<span title="${title}">${result}</span>`;
                            }
                        }
                    }
                    tableHtml += `<td class="w-16 text-center hidden md:table-cell">${roundCell}</td>`;
                }

                activeTiebreakers.forEach(tb => {
                    if (TIEBREAKERS[tb.key]) tableHtml += `<td class="w-24 text-right hidden lg:table-cell">${p.tiebreakers[tb.key] !== undefined ? p.tiebreakers[tb.key].toFixed(2) : '0.00'}</td>`;
                });
                tableHtml += `</tr>`;
            });

            tableHtml += '</tbody></table>';
            standingsView.innerHTML = tableHtml;
        };
        
        const renderPairings = () => {
            const t = getCurrentTournament();
            if (!t || t.currentRound === 0) {
                pairingsView.innerHTML = `<p class="text-text-secondary text-center py-4">Добавьте участников и сгенерируйте тур.</p>`;
                return;
            }
            const roundData = t.pairings[t.currentRound - 1];
            if (!roundData) {
                 pairingsView.innerHTML = `<p class="text-text-secondary text-center py-4">Жеребьевка для этого тура еще не создана.</p>`;
                 return;
            }

            let pairingsHtml = `<div class="space-y-3">`;
            roundData.pairs.forEach((pair, index) => {
                const p1 = getParticipantById(pair.player1);
                const p2 = getParticipantById(pair.player2);
                if (!p1 || !p2) return;

                const p1Color = pair.p1Color;
                pairingsHtml += `
                    <div class="grid grid-cols-12 gap-2 items-center text-center bg-surface2 p-3 rounded-lg text-sm sm:text-base">
                        <div class="col-span-1 text-text-secondary">${index + 1}</div>
                        <div class="col-span-4 text-right truncate font-bold" data-player-id="${p1.id}">${p1.name} ${t.settings.isRated ? `(${p1.rating})` : ''}</div>
                        <div class="col-span-2">
                            <select class="result-select w-full" data-pair-index="${index}" ${roundData.completed ? 'disabled' : ''}>
                                <option value="-" ${pair.result === '-' ? 'selected' : ''}>-</option>
                                <option value="1-0" ${pair.result === '1-0' ? 'selected' : ''}>1-0</option>
                                <option value="0-1" ${pair.result === '0-1' ? 'selected' : ''}>0-1</option>
                                <option value="1/2-1/2" ${pair.result === '1/2-1/2' ? 'selected' : ''}>½-½</option>
                                <option value="0-0" ${pair.result === '0-0' ? 'selected' : ''}>0-0</option>
                            </select>
                        </div>
                        <div class="col-span-4 text-left truncate font-bold" data-player-id="${p2.id}">${p2.name} ${t.settings.isRated ? `(${p2.rating})` : ''}</div>
                        <div class="col-span-1 flex justify-center space-x-1">
                            <div class="w-4 h-4 rounded-full ${p1Color === 'w' ? 'bg-white' : 'bg-gray-900'} border border-gray-400"></div>
                            <div class="w-4 h-4 rounded-full ${p1Color === 'b' ? 'bg-white' : 'bg-gray-900'} border border-gray-400"></div>
                        </div>
                    </div>
                `;
            });
            if (roundData.bye) {
                const byePlayer = getParticipantById(roundData.bye);
                if(byePlayer) pairingsHtml += `<div class="text-center mt-4 p-3 bg-green-900/50 border border-green-700 rounded-lg"><i class="fas fa-coffee text-yellow-400 mr-2"></i><span><b>${byePlayer.name}</b> пропускает тур (bye) и получает 1 очко.</span></div>`;
            }
            pairingsHtml += `</div>`;
            pairingsView.innerHTML = pairingsHtml;
        };
        
        const renderRoundControls = () => {
            const t = getCurrentTournament();
            if (!t) return;
            let controlsHtml = '';
            const roundIsGenerated = t.pairings.length >= t.currentRound && t.currentRound > 0;
            const roundIsCompleted = roundIsGenerated && t.pairings[t.currentRound - 1]?.completed;
            const isTournamentFinished = roundIsCompleted && t.currentRound === t.settings.totalRounds;

            if (isTournamentFinished) {
                controlsHtml = `<span class="font-bold text-green-400"><i class="fas fa-trophy mr-2"></i>Турнир завершен!</span>`;
            } else if (t.currentRound === 0) {
                controlsHtml = `<button id="generate-round-btn" class="btn btn-primary"><i class="fas fa-cogs mr-2"></i>Начать 1-й тур</button>`;
            } else {
                controlsHtml += `<span class="font-bold text-white mr-4">Тур ${t.currentRound} / ${t.settings.totalRounds}</span>`;
                if (roundIsGenerated && !roundIsCompleted) {
                    controlsHtml += `<button id="complete-round-btn" class="btn btn-primary"><i class="fas fa-check mr-2"></i>Завершить тур</button>`;
                } else if (roundIsCompleted) {
                    controlsHtml += `<button id="generate-round-btn" class="btn btn-primary"><i class="fas fa-cogs mr-2"></i>Начать тур ${t.currentRound + 1}</button>`;
                }
            }
            roundControls.innerHTML = controlsHtml;
        };

        const renderSettings = () => {
            const t = getCurrentTournament();
            if (!t) return;
            tiebreakersList.innerHTML = '';
            const allTiebreakers = { ...TIEBREAKERS };

            const currentTiebreakers = t.settings.tiebreakers.reduce((acc, curr) => {
                acc[curr.key] = curr.priority;
                return acc;
            }, {});

            for (const key in allTiebreakers) {
                const priority = currentTiebreakers[key] || 0;
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center gap-4';
                item.innerHTML = `
                    <label for="tb-priority-${key}" class="flex-grow">${allTiebreakers[key]}</label>
                    <input type="number" id="tb-priority-${key}" data-key="${key}" value="${priority}" min="0" class="input-field w-24 text-center">
                `;
                tiebreakersList.appendChild(item);
            }
        };

        const updateAllScores = () => {
            const t = getCurrentTournament();
            if (!t) return;
            t.participants.forEach(p => {
                p.score = p.results.reduce((total, result) => total + result, 0);
            });
        };

        const createNewTournament = (formData) => {
            const defaultTiebreakers = [
                { key: "directEncounter", priority: 1 }, { key: "buchholz", priority: 2 }, 
                { key: "sonnebornBerger", priority: 3 }, { key: "berger", priority: 4 },
                { key: "medianBuchholz", priority: 0 }, { key: "wins", priority: 0 }, 
                { key: "winsWithBlack", priority: 0 }, { key: "koya", priority: 0 }, { key: "progressive", priority: 0 }
            ];

            const newTournament = {
                id: generateId(),
                name: formData.name,
                timeControl: formData.timeControl,
                lastModified: Date.now(),
                settings: {
                    type: 'swiss',
                    totalRounds: parseInt(formData.totalRounds),
                    isRated: formData.isRated,
                    ratingSystem: formData.ratingSystem,
                    kFactor: parseInt(formData.kFactor),
                    tiebreakers: defaultTiebreakers
                },
                participants: [],
                pairings: [],
                currentRound: 0,
                notepadContent: ""
            };
            tournaments.push(newTournament);
            saveAllTournaments();
            currentTournamentId = newTournament.id;
            renderDashboard();
            showScreen('dashboard');
        };

        const addParticipant = (name, rating) => {
            const t = getCurrentTournament();
            if (!t || t.currentRound > 0) return;
            const newParticipant = {
                id: generateId(), name, rating: t.settings.isRated ? parseInt(rating) || 1200 : null,
                score: 0, opponents: [], colors: [], results: [], hadBye: false, tiebreakers: {},
                frozen: false, startingNumber: 0
            };
            t.participants.push(newParticipant);
            saveAllTournaments();
            renderParticipants();
            renderStandings();
        };
        
        const removeParticipant = (id) => {
            const t = getCurrentTournament();
            if (!t || t.currentRound > 0) return;
            t.participants = t.participants.filter(p => p.id !== id);
            saveAllTournaments();
            renderParticipants();
            renderStandings();
        };

        const toggleParticipantFrozen = (id) => {
            const t = getCurrentTournament();
            if (!t) return;
            const participant = getParticipantById(id);
            if (participant) {
                participant.frozen = !participant.frozen;
                saveAllTournaments();
                renderParticipants();
                renderStandings();
            }
        };

        const getParticipantById = (id) => getCurrentTournament()?.participants.find(p => p.id === id);

        const generateNextRound = () => {
            const t = getCurrentTournament();
            if (!t) return;
            
            if (t.currentRound === 0) {
                const sortedForStart = [...t.participants].sort((a, b) => (b.rating || 0) - (a.rating || 0) || a.name.localeCompare(b.name));
                sortedForStart.forEach((p, i) => {
                    const participantInTournament = getParticipantById(p.id);
                    if (participantInTournament) participantInTournament.startingNumber = i + 1;
                });
            }

            const activePlayers = t.participants.filter(p => !p.frozen);
            if (activePlayers.length < 2) { showAlertModal('Ошибка', 'Недостаточно активных участников для жеребьевки.'); return; }
            if (t.currentRound > 0 && !t.pairings[t.currentRound - 1]?.completed) { showAlertModal('Ошибка', 'Текущий тур еще не завершен.'); return; }

            t.currentRound++;
            const roundPairings = generateSwissPairings();
            t.pairings.push(roundPairings);
            
            calculateAllTiebreakers();
            saveAllTournaments();
            renderDashboard();
        };

        function generateSwissPairings() {
            const t = getCurrentTournament();
            let playersToPair = JSON.parse(JSON.stringify(t.participants.filter(p => !p.frozen)));
            let byePlayerId = null;

            if (playersToPair.length % 2 !== 0) {
                let eligibleForBye = playersToPair.filter(p => !p.hadBye);
                if (eligibleForBye.length === 0) {
                    eligibleForBye = playersToPair; 
                }
                
                let playerToGetBye;
                if (t.currentRound === 1) {
                    playerToGetBye = eligibleForBye[Math.floor(Math.random() * eligibleForBye.length)];
                } else {
                    eligibleForBye.sort((a, b) => (a.score - b.score) || ((a.rating || 0) - (b.rating || 0)));
                    playerToGetBye = eligibleForBye[0];
                }
                
                byePlayerId = playerToGetBye.id;
                const originalByePlayer = getParticipantById(byePlayerId);
                if (originalByePlayer) {
                    originalByePlayer.hadBye = true;
                    originalByePlayer.results.push(1);
                    originalByePlayer.opponents.push('bye');
                    originalByePlayer.colors.push('none');
                }
                playersToPair = playersToPair.filter(p => p.id !== byePlayerId);
            }

            const findPairingsRecursive = (players) => {
                if (players.length === 0) {
                    return [];
                }

                players.sort((a, b) => (b.score - a.score) || ((b.rating || 0) - (a.rating || 0)));
                
                const p1 = players[0];
                const rest = players.slice(1);

                for (let i = 0; i < rest.length; i++) {
                    const p2 = rest[i];

                    if (p1.opponents.includes(p2.id)) {
                        continue;
                    }

                    const remainingPlayers = rest.filter((_, index) => index !== i);
                    const subsequentPairs = findPairingsRecursive(remainingPlayers);

                    if (subsequentPairs !== null) {
                        const p1Original = getParticipantById(p1.id);
                        const p2Original = getParticipantById(p2.id);
                        
                        const p1ColorPref = p1Original.colors.filter(c => c === 'w').length - p1Original.colors.filter(c => c === 'b').length;
                        const p2ColorPref = p2Original.colors.filter(c => c === 'w').length - p2Original.colors.filter(c => c === 'b').length;
                        
                        let p1Color = 'w';
                        if (p1ColorPref > p2ColorPref) {
                            p1Color = 'b';
                        } else if (p2ColorPref > p1ColorPref) {
                            p1Color = 'w';
                        } else {
                            if ((p1Original.rating || 0) > (p2Original.rating || 0)) {
                                p1Color = 'w';
                            } else {
                                p1Color = Math.random() < 0.5 ? 'w' : 'b';
                            }
                        }

                        const currentPair = { player1: p1.id, player2: p2.id, result: '-', p1Color };
                        return [currentPair, ...subsequentPairs];
                    }
                }
                return null;
            };

            const finalPairs = findPairingsRecursive(playersToPair);

            if (finalPairs === null) {
                console.error("CRITICAL: Could not create a valid pairing for all players.");
                showAlertModal('Ошибка жеребьевки', 'Не удалось создать пары без повторных встреч. Проверьте историю партий.');
                return { pairs: [], bye: byePlayerId, completed: false };
            }

            return { pairs: finalPairs, bye: byePlayerId, completed: false };
        }
        
        const completeCurrentRound = () => {
            const t = getCurrentTournament();
            const roundData = t.pairings[t.currentRound - 1];
            if (!roundData || roundData.pairs.some(p => p.result === '-')) { showAlertModal('Ошибка', 'Пожалуйста, введите все результаты тура.'); return; }

            roundData.pairs.forEach(pair => {
                const p1 = getParticipantById(pair.player1);
                const p2 = getParticipantById(pair.player2);
                if (p1 && p2 && !p1.opponents.includes(p2.id)) {
                    p1.opponents.push(p2.id); p2.opponents.push(p1.id);
                    p1.colors.push(pair.p1Color); p2.colors.push(pair.p1Color === 'w' ? 'b' : 'w');
                    let p1res, p2res;
                    if (pair.result === '1-0') { p1res=1; p2res=0; }
                    else if (pair.result === '0-1') { p1res=0; p2res=1; }
                    else if (pair.result === '1/2-1/2') { p1res=0.5; p2res=0.5; }
                    else { p1res=0; p2res=0; }
                    p1.results.push(p1res); p2.results.push(p2res);
                }
            });

            roundData.completed = true;
            calculateAllTiebreakers();
            saveAllTournaments();
            renderDashboard();
        };

        const calculateAllTiebreakers = () => {
            const t = getCurrentTournament();
            updateAllScores();

            t.participants.forEach(p => {
                p.tiebreakers = {};
                const opponentsObjects = p.opponents.map(id => getParticipantById(id)).filter(Boolean);

                p.tiebreakers.directEncounter = opponentsObjects.reduce((sum, opp, i) => { return opp && opp.score === p.score ? sum + p.results[i] : sum; }, 0);
                p.tiebreakers.sonnebornBerger = opponentsObjects.reduce((sum, opp, i) => sum + (opp?.score || 0) * p.results[i], 0);
                p.tiebreakers.wins = p.results.filter(r => r === 1).length;
                p.tiebreakers.buchholz = opponentsObjects.reduce((sum, opp) => sum + (opp?.score || 0), 0);
                p.tiebreakers.winsWithBlack = p.results.reduce((sum, res, i) => sum + (res === 1 && p.colors[i] === 'b' ? 1 : 0), 0);
                let prog = 0; p.tiebreakers.progressive = p.results.reduce((sum, res) => { prog += res; return sum + prog; }, 0);
                
                if (opponentsObjects.length > 1) {
                    const scores = opponentsObjects.map(opp => opp.score).sort((a,b) => a-b);
                    p.tiebreakers.medianBuchholz = p.tiebreakers.buchholz - scores[0] - (scores.length > 2 ? scores[scores.length-1] : 0);
                } else { p.tiebreakers.medianBuchholz = p.tiebreakers.buchholz; }
                
                p.tiebreakers.berger = opponentsObjects.reduce((sum, opp, i) => {
                    if (p.results[i] === 1) return sum + opp.score;
                    if (p.results[i] === 0.5) return sum + opp.score / 2;
                    return sum;
                }, 0);
            });
        };
        
        const getSortedParticipants = () => {
            const t = getCurrentTournament();
            updateAllScores();
            const activeTiebreakers = t.settings.tiebreakers.filter(tb => tb.priority > 0).sort((a, b) => a.priority - b.priority);
            
            return [...t.participants].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                for (const tb of activeTiebreakers) {
                    const key = tb.key;
                    if ((b.tiebreakers[key] || 0) !== (a.tiebreakers[key] || 0)) return (b.tiebreakers[key] || 0) - (a.tiebreakers[key] || 0);
                }
                return (b.rating || 0) - (a.rating || 0) || a.name.localeCompare(b.name);
            });
        };

        const showPlayerInfo = (playerId) => {
            const player = getParticipantById(playerId);
            if (!player) return;

            playerInfoTitle.textContent = `История партий: ${player.name} (${player.score} очков)`;
            let contentHtml = '<div class="space-y-2">';
            if (player.opponents.length === 0) {
                contentHtml += '<p>Еще не сыграно ни одной партии.</p>';
            } else {
                player.opponents.forEach((oppId, index) => {
                    const result = player.results[index];
                    const color = player.colors[index];
                    let resultStr = '';
                    if (result === 1) resultStr = '1-0';
                    else if (result === 0.5) resultStr = '½-½';
                    else if (result === 0) resultStr = '0-1';

                    if (oppId === 'bye') {
                        contentHtml += `<div class="flex justify-between items-center bg-surface2 p-2 rounded"><span>Тур ${index + 1}: Пропуск (bye)</span> <span class="font-bold text-green-400">+1</span></div>`;
                    } else {
                        const opponent = getParticipantById(oppId);
                        contentHtml += `
                            <div class="flex justify-between items-center bg-surface2 p-2 rounded">
                                <span>Тур ${index + 1} ( <i class="fas fa-circle ${color === 'w' ? 'text-white' : 'text-gray-800'} border border-gray-500 rounded-full"></i> ) vs ${opponent.name}</span>
                                <span class="font-bold">${resultStr}</span>
                            </div>
                        `;
                    }
                });
            }
            contentHtml += '</div>';
            playerInfoContent.innerHTML = contentHtml;
            toggleModal(playerInfoModal, true);
        };

        const copyStandingsToClipboard = () => {
            const table = standingsView.querySelector('table');
            if (!table) return;

            let text = '';
            table.querySelectorAll('tr').forEach(row => {
                let rowText = [];
                row.querySelectorAll('th, td').forEach(cell => {
                    rowText.push(cell.innerText);
                });
                text += rowText.join('\t') + '\n';
            });
            
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showAlertModal('Скопировано!', 'Турнирная таблица скопирована в буфер обмена.');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showAlertModal('Ошибка', 'Не удалось скопировать таблицу.');
            }
            document.body.removeChild(textArea);
        };

        const addEventListeners = () => {
            goToSetupBtn.addEventListener('click', () => showScreen('setup'));
            backToHomeBtn.addEventListener('click', () => showScreen('home'));
            backToHomeDashboardBtn.addEventListener('click', () => {
                renderHomeScreen();
                showScreen('home');
            });

            setupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                createNewTournament({
                    name: document.getElementById('tournament-name').value,
                    totalRounds: totalRoundsInput.value,
                    timeControl: document.getElementById('time-control').value,
                    isRated: isRatedToggle.checked,
                    ratingSystem: document.getElementById('rating-system').value,
                    kFactor: document.getElementById('k-factor').value
                });
            });

            isRatedToggle.addEventListener('change', (e) => ratingSettingsPanel.classList.toggle('hidden', !e.target.checked));
            
            addParticipantForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('participant-name');
                const ratingInput = document.getElementById('participant-rating');
                if (nameInput.value.trim()) {
                    addParticipant(nameInput.value.trim(), ratingInput.value);
                    nameInput.value = ''; ratingInput.value = '';
                    nameInput.focus();
                }
            });

            participantsList.addEventListener('click', (e) => { 
                const deleteBtn = e.target.closest('.delete-participant-btn');
                const freezeBtn = e.target.closest('.freeze-participant-btn');
                if (deleteBtn) removeParticipant(deleteBtn.dataset.id); 
                if (freezeBtn) toggleParticipantFrozen(freezeBtn.dataset.id);
            });

            roundControls.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.id === 'generate-round-btn') generateNextRound();
                if (target.id === 'complete-round-btn') completeCurrentRound();
            });

            pairingsView.addEventListener('change', (e) => {
                if (e.target.classList.contains('result-select')) {
                    const pairIndex = parseInt(e.target.dataset.pairIndex);
                    const result = e.target.value;
                    getCurrentTournament().pairings[getCurrentTournament().currentRound - 1].pairs[pairIndex].result = result;
                    saveAllTournaments();
                }
            });

            notepadContent.addEventListener('input', () => { const t = getCurrentTournament(); if (t) { t.notepadContent = notepadContent.value; saveAllTournaments(); } });
            
            settingsBtn.addEventListener('click', () => { renderSettings(); toggleModal(settingsModal, true); });
            closeSettingsModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));
            
            closePlayerInfoModalBtn.addEventListener('click', () => toggleModal(playerInfoModal, false));
            
            standingsView.addEventListener('click', (e) => {
                const target = e.target.closest('.player-name-clickable');
                if (target && target.dataset.playerId) {
                    showPlayerInfo(target.dataset.playerId);
                }
            });
            
            copyStandingsBtn.addEventListener('click', copyStandingsToClipboard);

            deleteTournamentBtn.addEventListener('click', async () => {
                const t = getCurrentTournament();
                if (t) {
                    await showConfirmModal(
                        'Удалить турнир?',
                        `Вы уверены, что хотите удалить турнир "${t.name}"? Это действие необратимо.`,
                        () => {
                            tournaments = tournaments.filter(tourn => tourn.id !== t.id);
                            saveAllTournaments();
                            toggleModal(settingsModal, false);
                            renderHomeScreen();
                            showScreen('home');
                        }
                    );
                }
            });
            
            tiebreakersList.addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT') {
                    const t = getCurrentTournament();
                    const key = e.target.dataset.key;
                    const newPriority = parseInt(e.target.value) || 0;
                    const tb = t.settings.tiebreakers.find(tb => tb.key === key);
                    if (tb) {
                        tb.priority = newPriority;
                    } else {
                        t.settings.tiebreakers.push({ key: key, priority: newPriority });
                    }
                    saveAllTournaments();
                    renderStandings();
                }
            });
        };

        addEventListeners();
        initializeApp();
    });
    </script>
</body>
</html>
